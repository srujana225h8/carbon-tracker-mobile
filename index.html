<!DOCTYPE html>
<html>
<head>
    <title>Carbon Tracker - Mobile GPS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        button { padding: 15px 25px; margin: 10px; font-size: 18px; border: none; border-radius: 8px; cursor: pointer; }
        .start-btn { background: #4CAF50; color: white; }
        .stop-btn { background: #f44336; color: white; }
        .success { color: green; font-weight: bold; font-size: 18px; }
        .error { color: red; font-size: 18px; }
        .results { background: #f5f5f5; padding: 20px; border-radius: 10px; margin-top: 20px; }
        .code { font-family: monospace; background: white; padding: 15px; border: 2px dashed #ccc; font-size: 20px; margin: 15px 0; }
        .instruction { background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 5px solid #2196F3; }
        .status-box { padding: 15px; background: #fff3cd; border-radius: 8px; margin: 15px 0; border: 2px solid #ffc107; }
        .distance-display { font-size: 36px; font-weight: bold; color: #2196F3; text-align: center; margin: 20px 0; }
        .vehicle-select { margin: 20px 0; }
        .vehicle-option { display: inline-block; padding: 10px 20px; margin: 5px; background: #e0e0e0; border-radius: 5px; cursor: pointer; }
        .vehicle-option.selected { background: #2196F3; color: white; }
    </style>
</head>
<body>
    <h1>üöó Carbon Tracker GPS</h1>
    <p>Track your commute distance in real-time for carbon footprint calculation</p>
    
    <div class="instruction">
        <strong>üì± How to use:</strong>
        <ol>
            <li>Click <strong>START TRACKING</strong> button</li>
            <li>Allow location access when prompted</li>
            <li>Begin your journey (walk, drive, etc.)</li>
            <li>Watch distance update in real-time</li>
            <li>Click <strong>STOP TRACKING</strong> when you arrive</li>
            <li>Select your vehicle type</li>
            <li>Copy the generated code</li>
            <li>Paste the code in Google Colab</li>
        </ol>
    </div>
    
    <div class="status-box">
        <div id="status">üìç Ready to start tracking...</div>
        <div id="gpsStatus" style="font-size: 14px; color: #666;">GPS: Waiting...</div>
    </div>
    
    <div class="distance-display" id="distanceDisplay">0.0 km</div>
    
    <button class="start-btn" onclick="startTracking()">üìç START TRACKING</button>
    <button class="stop-btn" onclick="stopTracking()">‚èπÔ∏è STOP TRACKING</button>
    <button onclick="resetTracking()">üîÑ RESET</button>
    
    <div class="vehicle-select" id="vehicleSelect" style="display: none;">
        <h3>Select Your Vehicle Type:</h3>
        <div class="vehicle-option" onclick="selectVehicle('Car')">üöó Car</div>
        <div class="vehicle-option" onclick="selectVehicle('Bus')">üöå Bus</div>
        <div class="vehicle-option" onclick="selectVehicle('Electric Vehicle')">‚ö° Electric Vehicle</div>
        <div class="vehicle-option" onclick="selectVehicle('Motorcycle')">üèçÔ∏è Motorcycle</div>
        <div class="vehicle-option" onclick="selectVehicle('Auto')">üõ∫ Auto</div>
        <div class="vehicle-option" onclick="selectVehicle('Walking')">üö∂ Walking</div>
        <div class="vehicle-option" onclick="selectVehicle('Bicycle')">üö≤ Bicycle</div>
        <p id="selectedVehicle">Selected: None</p>
    </div>
    
    <div class="results" id="results" style="display: none;">
        <h2>‚úÖ Tracking Complete!</h2>
        <p><strong>Total Distance:</strong> <span id="finalDistance">0.0</span> km</p>
        <p><strong>Vehicle Type:</strong> <span id="finalVehicle">None</span></p>
        <p><strong>GPS Points Recorded:</strong> <span id="pointCount">0</span></p>
        <p><strong>Tracking Time:</strong> <span id="trackingTime">0</span> seconds</p>
        
        <h3>üìã Your Tracking Code:</h3>
        <div class="code" id="trackingCode">Waiting for vehicle selection...</div>
        
        <button onclick="copyToClipboard()" style="background: #2196F3; color: white; padding: 12px 25px;">
            üìã COPY CODE TO CLIPBOARD
        </button>
        
        <p style="color: #666; margin-top: 10px;">
            Paste this code in the Google Colab program when prompted
        </p>
    </div>
    
    <script>
        // Global variables
        let watchId = null;
        let locations = [];
        let selectedVehicle = null;
        let startTime = null;
        let timerInterval = null;
        
        // Start tracking function
        function startTracking() {
            if (!navigator.geolocation) {
                showError("Geolocation is not supported by your browser.");
                return;
            }
            
            // Reset any existing tracking
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
            }
            
            // Reset tracking data
            locations = [];
            selectedVehicle = null;
            startTime = new Date();
            
            // Update UI
            document.getElementById('status').innerHTML = "üéØ <strong>Tracking started...</strong>";
            document.getElementById('status').className = "success";
            document.getElementById('gpsStatus').innerHTML = "GPS: Active (updating every 3 seconds)";
            document.getElementById('vehicleSelect').style.display = 'none';
            document.getElementById('results').style.display = 'none';
            
            // Clear any existing vehicle selection
            document.querySelectorAll('.vehicle-option').forEach(el => {
                el.classList.remove('selected');
            });
            document.getElementById('selectedVehicle').innerHTML = "Selected: None";
            
            // Start timer
            startTimer();
            
            // Get initial position with high accuracy
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    // Success - add first point
                    const loc = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        time: new Date().toISOString(),
                        accuracy: position.coords.accuracy
                    };
                    locations.push(loc);
                    
                    // Update display
                    updateDisplay();
                    
                    // Start watching position with more frequent updates
                    watchId = navigator.geolocation.watchPosition(
                        function(pos) {
                            const newLoc = {
                                lat: pos.coords.latitude,
                                lng: pos.coords.longitude,
                                time: new Date().toISOString(),
                                accuracy: pos.coords.accuracy
                            };
                            
                            // Only add point if it's significantly different from last point
                            if (locations.length === 0 || 
                                calculateDistance(locations[locations.length-1], newLoc) > 0.001) {
                                locations.push(newLoc);
                                updateDisplay();
                            }
                        },
                        function(error) {
                            handleGeolocationError(error);
                        },
                        {
                            enableHighAccuracy: true,  // Use GPS if available
                            maximumAge: 0,            // Don't use cached position
                            timeout: 10000           // 10 second timeout
                        }
                    );
                },
                function(error) {
                    handleGeolocationError(error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0
                }
            );
        }
        
        // Stop tracking function
        function stopTracking() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                
                // Stop timer
                clearInterval(timerInterval);
                
                // Update status
                document.getElementById('status').innerHTML = "‚èπÔ∏è <strong>Tracking stopped</strong>";
                document.getElementById('status').className = "";
                document.getElementById('gpsStatus').innerHTML = "GPS: Stopped";
                
                // Calculate final distance
                const distance = calculateTotalDistance();
                document.getElementById('finalDistance').textContent = distance.toFixed(2);
                document.getElementById('pointCount').textContent = locations.length;
                
                // Show vehicle selection
                document.getElementById('vehicleSelect').style.display = 'block';
                
                // Show results section
                document.getElementById('results').style.display = 'block';
                
                // Scroll to results
                document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        // Reset tracking function
        function resetTracking() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            // Clear all data
            locations = [];
            selectedVehicle = null;
            startTime = null;
            
            // Clear timer
            clearInterval(timerInterval);
            
            // Reset UI
            document.getElementById('status').innerHTML = "üìç Ready to start tracking...";
            document.getElementById('status').className = "";
            document.getElementById('gpsStatus').innerHTML = "GPS: Waiting...";
            document.getElementById('distanceDisplay').textContent = "0.0 km";
            document.getElementById('vehicleSelect').style.display = 'none';
            document.getElementById('results').style.display = 'none';
            document.getElementById('selectedVehicle').innerHTML = "Selected: None";
            
            // Clear vehicle selection
            document.querySelectorAll('.vehicle-option').forEach(el => {
                el.classList.remove('selected');
            });
        }
        
        // Calculate distance between two points (Haversine formula)
        function calculateDistance(point1, point2) {
            const R = 6371; // Earth's radius in km
            const dLat = (point2.lat - point1.lat) * Math.PI / 180;
            const dLng = (point2.lng - point1.lng) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(point1.lat * Math.PI / 180) * Math.cos(point2.lat * Math.PI / 180) * 
                Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // Calculate total distance from all points
        function calculateTotalDistance() {
            if (locations.length < 2) return 0;
            
            let totalDistance = 0;
            for (let i = 1; i < locations.length; i++) {
                totalDistance += calculateDistance(locations[i-1], locations[i]);
            }
            return totalDistance;
        }
        
        // Update display during tracking
        function updateDisplay() {
            const distance = calculateTotalDistance();
            
            // Update distance display
            document.getElementById('distanceDisplay').textContent = distance.toFixed(2) + " km";
            
            // Update status with point count
            document.getElementById('status').innerHTML = 
                `üìç <strong>Tracking... (${locations.length} points recorded)</strong>`;
        }
        
        // Handle geolocation errors
        function handleGeolocationError(error) {
            let message = "";
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = "Location permission denied. Please allow location access in your browser settings.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = "Location information unavailable. Make sure GPS/WiFi is enabled.";
                    break;
                case error.TIMEOUT:
                    message = "Location request timed out. Please try again.";
                    break;
                default:
                    message = "An unknown error occurred: " + error.message;
            }
            
            document.getElementById('status').innerHTML = "‚ùå " + message;
            document.getElementById('status').className = "error";
            document.getElementById('gpsStatus').innerHTML = "GPS: Error";
            
            // Stop tracking on error
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
        }
        
        // Show error message
        function showError(msg) {
            document.getElementById('status').innerHTML = msg;
            document.getElementById('status').className = "error";
        }
        
        // Select vehicle type
        function selectVehicle(vehicle) {
            selectedVehicle = vehicle;
            
            // Update UI
            document.querySelectorAll('.vehicle-option').forEach(el => {
                el.classList.remove('selected');
                if (el.textContent.includes(vehicle)) {
                    el.classList.add('selected');
                }
            });
            
            document.getElementById('selectedVehicle').innerHTML = "Selected: " + vehicle;
            document.getElementById('finalVehicle').textContent = vehicle;
            
            // Generate and show tracking code
            generateTrackingCode();
        }
        
        // Generate tracking code
        function generateTrackingCode() {
            if (!selectedVehicle) {
                document.getElementById('trackingCode').textContent = "Please select a vehicle first!";
                return;
            }
            
            const distance = calculateTotalDistance();
            const timestamp = Math.floor(Date.now() / 1000);
            
            // Format vehicle name (remove spaces for code)
            const vehicleCode = selectedVehicle.replace(/\s+/g, '_');
            
            // Create code
            const code = `${distance.toFixed(2)}_${vehicleCode}_${timestamp}`;
            
            // Display code
            document.getElementById('trackingCode').textContent = code;
        }
        
        // Copy code to clipboard
        function copyToClipboard() {
            const code = document.getElementById('trackingCode').textContent;
            
            if (code.includes("Please select")) {
                alert("Please select a vehicle type first!");
                return;
            }
            
            navigator.clipboard.writeText(code).then(
                function() {
                    alert("‚úÖ Code copied to clipboard!\n\nCode: " + code + "\n\nPaste this in Google Colab when prompted.");
                },
                function(err) {
                    // Fallback for older browsers
                    const textArea = document.createElement("textarea");
                    textArea.value = code;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand("copy");
                    document.body.removeChild(textArea);
                    alert("‚úÖ Code copied to clipboard!\n\nCode: " + code);
                }
            );
        }
        
        // Start timer
        function startTimer() {
            clearInterval(timerInterval);
            startTime = new Date();
            
            timerInterval = setInterval(function() {
                if (startTime) {
                    const elapsed = Math.floor((new Date() - startTime) / 1000);
                    document.getElementById('trackingTime').textContent = elapsed;
                }
            }, 1000);
        }
        
        // Initialize
        window.onload = function() {
            console.log("Carbon Tracker GPS loaded successfully");
        };
    </script>
    
    <footer style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; color: #666; font-size: 14px;">
        <p><strong>Note:</strong> This tracker uses your browser's geolocation API to calculate distance. For best results:</p>
        <ul>
            <li>Use Google Chrome or Safari on your phone</li>
            <li>Allow location permission when prompted</li>
            <li>Keep the browser open while tracking</li>
            <li>Move around to see distance updates</li>
        </ul>
        <p>üìç Distance is calculated using GPS coordinates (Haversine formula)</p>
    </footer>
</body>
</html>
